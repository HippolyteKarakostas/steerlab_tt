<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Démo autocomplete</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 2rem auto; }
    .wrap { display:flex; flex-direction:column; gap:.4rem; margin-bottom: 1rem; }
    .row  { display:flex; gap:.5rem; }
    .row input, .row select { padding:.5rem; font-size:1rem; }
    .row input { flex:1; }
    button { padding:.5rem .8rem; }
    .sug  { border:1px solid #ccc; display:none; margin-top:.25rem; }
    .sug div { padding:.4rem .5rem; cursor:pointer; }
    .sug div:hover { background:#f2f2f2; }
    #title_msg { margin-top:.4rem; font-size:.95rem; }
    #title_msg.ok { color: green; }
    #title_msg.error { color: #a00; }
  </style>
</head>
<body>
  <h1>Recherche</h1>

  <!-- TITRES -->
  <div class="wrap" id="title_block">
    <div class="row">
      <!-- Menu mode à gauche -->
      <select id="title_mode" aria-label="Mode de recherche pour les titres">
        <option value="title" selected>Titre</option>
        <option value="regexp">RegExp</option>
      </select>

      <input id="title_query" type="text" placeholder="Tape un titre…" autocomplete="off" />
      <button id="browse_btn" type="button">Browse</button>
    </div>
    <div id="title_sug" class="sug"></div>
    <div id="title_msg"></div>
  </div>

  <!-- AUTEURS -->
  <div class="wrap" id="auth_block">
    <input id="auth_query" type="text" placeholder="Tape un auteur…" autocomplete="off" />
    <div id="auth_sug" class="sug"></div>
  </div>

  <script>
    // --- Autocomplete générique (réutilisable) ---
    // Ajout: "getUrl" peut être une fonction (q) => string pour calculer l’URL dynamiquement.
    function setupAutocomplete({inputId, sugId, url, getUrl, renderItem}) {
      const input = document.getElementById(inputId);
      const box   = document.getElementById(sugId);

      input.addEventListener('input', async () => {
        const q = input.value.trim();
        if (!q) { box.style.display='none'; box.innerHTML=''; return; }

        const endpoint = typeof getUrl === 'function' ? getUrl(q) : (url + encodeURIComponent(q));

        try {
          const r = await fetch(endpoint);
          const items = await r.json();
          if (!items.length) { box.style.display='none'; box.innerHTML=''; return; }

          box.innerHTML = items.map(renderItem).join('');
          box.style.display = 'block';
        } catch {
          box.style.display='none'; box.innerHTML='';
        }
      });

      box.addEventListener('click', (e) => {
        const div = e.target.closest('div');
        if (!div) return;
        input.value = div.textContent;
        box.style.display='none'; box.innerHTML='';
      });

      document.addEventListener('click', (e) => {
        if (e.target !== input && !box.contains(e.target)) {
          box.style.display='none'; box.innerHTML='';
        }
      });
    }

    // TITRES (avec paramètre mode dans /suggest)
    const titleMode = document.getElementById('title_mode');
    setupAutocomplete({
      inputId: 'title_query',
      sugId:   'title_sug',
      getUrl:  (q) => `/suggest?title_query=${encodeURIComponent(q)}&mode=${encodeURIComponent(titleMode.value)}`,
      renderItem: x => `<div data-url="${x.url || ''}"><strong>${x.title}</strong>${x.author ? ' — ' + x.author : ''}</div>`
    });

    // AUTEURS (inchangé)
    setupAutocomplete({
      inputId: 'auth_query',
      sugId:   'auth_sug',
      url:     '/suggest?auth_query=',
      renderItem: x => `<div data-url="${x.url || ''}"><strong>${x.author || x.title || ''}</strong></div>`
    });

    // --- Bouton Browse ---
    const browseBtn  = document.getElementById('browse_btn');
    const titleInput = document.getElementById('title_query');
    const titleMsg   = document.getElementById('title_msg');

    browseBtn.addEventListener('click', async () => {
      const q = titleInput.value.trim();
      titleMsg.textContent = '';
      titleMsg.className = "";
      if (!q) { titleMsg.textContent = "Veuillez saisir un titre."; return; }

      try {
        const r = await fetch('/resolve_title?title_query=' + encodeURIComponent(q));
        const data = await r.json();
        titleMsg.textContent = data.message;
        window.open(data.url, '_blank', 'noopener');
        if (data.ok) {
          titleMsg.classList.add("ok");
        }
        else {
          titleMsg.classList.add("error");
        }
      } catch {
        titleMsg.textContent = "Erreur réseau. Réessayez.";
      }
    });
  </script>
</body>
</html>
